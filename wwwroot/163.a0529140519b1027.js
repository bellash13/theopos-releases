"use strict";(self.webpackChunktheopos=self.webpackChunktheopos||[]).push([[163],{7163:(J,L,s)=>{s.r(L),s.d(L,{PosModule:()=>j});var S=s(1920),T=s(9808),P=s(8505),M=s(8372),V=s(1884),q=s(3900),D=s(262),R=s(9646),F=s(2277),v=s(2291),d=s(2382),O=s(5439),C=s(1230),e=s(1223),A=s(2290),y=s(9150),x=s(6670);const B=["invoiceDialog"],E=["productIdCtrl"],G=["quantityCtrl"],Q=[{path:"",component:(()=>{class n{constructor(t,i,o,r,c,a){this.partnersServ=t,this.productsServ=i,this.invoiceServ=o,this.fb=r,this.toastr=c,this.modalService=a,this.partners=[],this.products=[],this.productSearching=!1,this.productSearchFailed=!1,this.productView="grid",this.orderPage=1,this.orderPageSize=4,this.productSearch=u=>u.pipe((0,M.b)(300),(0,V.x)(),(0,P.b)(()=>{this.productSearching=!0}),(0,q.w)(h=>this.productsServ.index(h,0,20).pipe((0,P.b)(m=>{this.productSearchFailed=!1,1===m.length&&this.selectProduct(m[0])}),(0,D.K)(()=>(this.productSearchFailed=!0,(0,R.of)([]))))),(0,P.b)(()=>{this.productSearching=!1})),this.productFormatter=u=>u.itemId}ngAfterViewInit(){this.setFocusForControls()}ngOnInit(){this.getPartners()}buildForm(){this.getProducts(),this.currentInvoice||(this.currentInvoice=new v.mw({idCurrency:"CDF",idPartner:this.partners.length?this.partners[0].partnerId:""})),this.orderForm=this.fb.group({invoiceId:[this.currentInvoice.invoiceId,[]],idPartner:[this.currentInvoice.idPartner,[d.kI.required]],invoiceDate:[this.currentInvoice.invoiceDate||O.utc(new Date),[d.kI.required]],description:[this.currentInvoice.description,[]],rate:[2e3,[]],idCurrency:[this.currentInvoice.idCurrency,[]],total:[0,[]],invoiceLines:this.fb.array([])}),(this.currentInvoice.invoiceLines||[]).forEach(t=>{this.addLine(t,!1)}),this.setOrderTotal(),this.buildLineForm(new v.Fm)}setOrderTotal(){var t;let i=0;(this.orderForm.get("invoiceLines").value||[]).forEach(o=>{i+=o.total||0}),null===(t=this.orderForm.get("total"))||void 0===t||t.setValue(i)}addLine(t,i=!0){var o,r,c,a,u;let h=!1;const m=this.orderForm.get("invoiceLines");if(m.controls.forEach(g=>{var b;const I=g,z=null===(b=null==I?void 0:I.get("idProduct"))||void 0===b?void 0:b.value;if(t.idProduct===z){const f=I.get("quantity"),H=(null==f?void 0:f.value)+t.quantity;null==f||f.setValue(H),I.updateValueAndValidity(),h=!0}}),h)return i&&this.toastr.info(`Quantit\xe9 mise \xe0 jour pour ${t.idProduct}`),void this.unselectProduct();const l=this.fb.group({discount:[t.discount||0,[]],idProduct:[t.idProduct||"",[d.kI.required]],productDescription:[(null===(o=t.product)||void 0===o?void 0:o.name)||"",[]],idInvoice:[t.idInvoice||"",[]],price:[t.price||0,[d.kI.required,d.kI.min(0)]],quantity:[t.quantity||1,[d.kI.min(0)]],invoiceLineId:[t.invoiceLineId||"",[]],subTotal:[t.subTotal||0,[]],total:[t.total||0,[]]});this.setInvoiceLineTotal(l),null===(r=l.get("quantity"))||void 0===r||r.valueChanges.subscribe(g=>{this.setInvoiceLineTotal(l)}),null===(c=l.get("price"))||void 0===c||c.valueChanges.subscribe(g=>{this.setInvoiceLineTotal(l)}),null===(a=l.get("discount"))||void 0===a||a.valueChanges.subscribe(g=>{this.setInvoiceLineTotal(l)}),null===(u=l.get("total"))||void 0===u||u.valueChanges.subscribe(g=>{this.setOrderTotal()}),m.push(l),this.setOrderTotal(),i&&this.toastr.info("Article ajout\xe9 \xe0 liste avec succ\xe8s."),this.unselectProduct()}setInvoiceLineTotal(t){var i,o,r,c;const m=(null===(i=t.get("price"))||void 0===i?void 0:i.value)*(null===(o=t.get("quantity"))||void 0===o?void 0:o.value)-(null===(r=t.get("discount"))||void 0===r?void 0:r.value);null===(c=t.get("total"))||void 0===c||c.setValue(m)}getProducts(){this.productsServ.index().subscribe(t=>{this.products=t})}selectProduct(t){var i,o,r;const c=t.productId===(null===(o=null===(i=this.currentLineForm)||void 0===i?void 0:i.get("idProduct"))||void 0===o?void 0:o.value);if(this.selectedProduct=t,c){const u=null===(r=this.currentLineForm)||void 0===r?void 0:r.get("quantity"),h=((null==u?void 0:u.value)||0)+1;return null==u||u.setValue(h),void this.setFocusForControls()}const a=new v.Fm({idProduct:this.selectedProduct.productId,price:this.selectedProduct.priceSell,quantity:1,product:new v.xs({name:this.selectedProduct.name})});this.buildLineForm(a)}buildLineForm(t){var i,o;this.currentLineForm=this.fb.group({idProduct:[t.idProduct||"",[d.kI.required]],product:this.fb.group({name:null===(i=null==t?void 0:t.product)||void 0===i?void 0:i.name}),discount:[t.discount||0,[]],price:[t.price||0,[d.kI.required,d.kI.min(0)]],quantity:[t.quantity||0,[d.kI.required,d.kI.min(0)]],total:[t.total||0,[d.kI.required,d.kI.min(0)]]}),null===(o=this.currentLineForm.get("quantity"))||void 0===o||o.valueChanges.subscribe(r=>{this.setInvoiceLineTotal(this.currentLineForm)}),this.setInvoiceLineTotal(this.currentLineForm),this.setFocusForControls()}setFocusForControls(){var t;null!==(t=this.currentLineForm)&&void 0!==t&&t.value.idProduct?(F.M.removeFocus(this.productIdCtrl),F.M.setFocus(this.quantityCtrl)):(F.M.removeFocus(this.quantityCtrl),setTimeout(()=>{F.M.setFocus(this.productIdCtrl,1)},500))}insertLine(){var t;!this.currentLineForm||!this.isValidLine(null===(t=this.currentLineForm)||void 0===t?void 0:t.value)||this.addLine(this.currentLineForm.value)}isValidLine(t){return!(!t||(null!=t&&t.idProduct?((null==t?void 0:t.quantity)||0)<=0?(this.toastr.error("Quantit\xe9 invalide."),1):((null==t?void 0:t.price)||0)<=0&&(this.toastr.error("Prix invalide."),1):(this.toastr.error("S\xe9lectionner un produit."),1)))}getPartners(){this.partnersServ.index().subscribe(t=>{this.partners=t,this.buildForm()},t=>{this.toastr.error("Aucun client disponible.")})}save(){this.orderForm.invalid?this.toastr.error("Formulaire invalide"):this.invoiceServ.create(this.orderForm.value).subscribe(t=>{this.toastr.success("Sauvegard\xe9e avec succ\xe8s."),this.newInvoice=t,this.open(this.invoiceDialog),this.buildForm()},t=>{this.toastr.error("Impossible de sauvegarder")})}cancel(){}pay(){}removeLine(t){var i;const o=this.orderForm.get("invoiceLines");for(var r=o.controls.length-1;r>=0;r--)t.idProduct&&(null===(i=o.controls[r].get("idProduct"))||void 0===i?void 0:i.value)===t.idProduct&&(o.controls.splice(r,1),r--)}open(t){this.modalService.open(t,{ariaLabelledBy:"modal-basic-title"}).result.then(i=>{},i=>{})}getDismissReason(t){return t===C.If.ESC?"by pressing ESC":t===C.If.BACKDROP_CLICK?"by clicking on a backdrop":`with: ${t}`}unselectProduct(){this.selectedProduct=null,this.buildLineForm(new v.Fm)}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(v.r6),e.Y36(v.b0),e.Y36(v.GR),e.Y36(d.qu),e.Y36(A._W),e.Y36(C.FF))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-pos"]],viewQuery:function(t,i){if(1&t&&(e.Gf(B,5),e.Gf(E,5),e.Gf(G,5)),2&t){let o;e.iGM(o=e.CRH())&&(i.invoiceDialog=o.first),e.iGM(o=e.CRH())&&(i.productIdCtrl=o.first),e.iGM(o=e.CRH())&&(i.quantityCtrl=o.first)}},decls:2,vars:1,consts:[[3,"InOut"]],template:function(t,i){1&t&&e._UZ(0,"router-outlet")(1,"app-invoices-edit",0),2&t&&(e.xp6(1),e.Q6J("InOut",!0))},dependencies:[y.lC,x.s]}),n})()}];let Y=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[y.Bz.forChild(Q),y.Bz]}),n})(),j=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[T.ez,Y,S.V]}),n})()}}]);